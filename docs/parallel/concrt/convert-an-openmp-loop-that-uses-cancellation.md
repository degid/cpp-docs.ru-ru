---
title: Практическое руководство. Преобразование цикла OpenMP, использующего отмену для использования среды выполнения с параллелизмом
ms.date: 11/04/2016
helpviewer_keywords:
- converting from OpenMP to the Concurrency Runtime, cancellation
- cancellation, converting from OpenMP to the Concurrency Runtime
ms.assetid: 4b0b3c33-bfa9-4e96-ae08-aef245a39cbb
ms.openlocfilehash: f4d4d8d1b2dbf60d0b4674229043c981d874292d
ms.sourcegitcommit: a8ef52ff4a4944a1a257bdaba1a3331607fb8d0f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/11/2020
ms.locfileid: "77141826"
---
# <a name="how-to-convert-an-openmp-loop-that-uses-cancellation-to-use-the-concurrency-runtime"></a>Практическое руководство. Преобразование цикла OpenMP, использующего отмену для использования среды выполнения с параллелизмом

Для некоторых параллельных циклов не требуется выполнение всех итераций. Например, алгоритм, который ищет значение, может завершиться после того, как значение найдено. OpenMP не предоставляет механизм для разбиения параллельного цикла. Однако можно использовать логическое значение или флаг, чтобы разрешить итерацию цикла указать, что решение найдено. Среда выполнения с параллелизмом предоставляет функциональные возможности, позволяющие одной задаче отменять другие задачи, которые еще не запущены.

В этом примере показано, как преобразовать [параллельный](../../parallel/concrt/how-to-use-parallel-invoke-to-write-a-parallel-sort-routine.md#parallel)цикл[for](../../parallel/openmp/reference/for-openmp.md) OpenMP, который не требуется для выполнения всех итераций, чтобы использовать механизм отмены среда выполнения с параллелизмом.

## <a name="example"></a>Пример

В этом примере используются OpenMP и среда выполнения с параллелизмом для реализации параллельной версии алгоритма [std:: any_of](../../standard-library/algorithm-functions.md#any_of) . В версии OpenMP этого примера используется флаг для координации всех итераций параллельных циклов, которые были удовлетворены условием. Версия, использующая среда выполнения с параллелизмом, использует метод [concurrency::structured_task_group:: Cancel](reference/structured-task-group-class.md#cancel) , чтобы остановить общую операцию при выполнении условия.

[!code-cpp[concrt-openmp#2](../../parallel/concrt/codesnippet/cpp/convert-an-openmp-loop-that-uses-cancellation_1.cpp)]

В этом примере формируются следующие данные:

```Output
Using OpenMP...
9114046 is in the array.
Using the Concurrency Runtime...
9114046 is in the array.
```

В версии, использующей OpenMP, все итерации цикла выполняются, даже если установлен флаг. Кроме того, если задача должна иметь дочерние задачи, этот флаг также должен быть доступен для этих дочерних задач, чтобы сообщить об отмене. В среда выполнения с параллелизмом при отмене группы задач среда выполнения отменяет все дерево работы, включая дочерние задачи. Алгоритм [arallel_for_each Concurrency::p](reference/concurrency-namespace-functions.md#parallel_for_each) использует задачи для выполнения работы. Таким образом, когда одна итерация цикла отменяет корневую задачу, все дерево вычислений также отменяется. При отмене дерева работы среда выполнения не запускает новые задачи. Однако среда выполнения позволяет выполнять задачи, которые уже начали работу. Таким образом, в случае алгоритма `parallel_for_each` активные итерации цикла могут очищать свои ресурсы.

В обеих версиях этого примера, если массив содержит более одной копии значения для поиска, несколько итераций цикла могут одновременно задать результат и отменить общую операцию. Вы можете использовать примитив синхронизации, например критический раздел, если проблема требует, чтобы при выполнении условия выполнялась только одна задача.

Можно также использовать обработку исключений для отмены задач, использующих PPL. Дополнительные сведения об отмене см. [в разделе Отмена в библиотеке PPL](cancellation-in-the-ppl.md).

Дополнительные сведения о `parallel_for_each` и других параллельных алгоритмах см. в разделе [Параллельные алгоритмы](../../parallel/concrt/parallel-algorithms.md).

## <a name="compiling-the-code"></a>Компиляция кода

Скопируйте пример кода и вставьте его в проект Visual Studio или вставьте в файл с именем `concrt-omp-parallel-any-of.cpp`, а затем выполните следующую команду в окне командной строки Visual Studio.

> **CL. exe/EHsc/OpenMP конкрт-ОМП-Параллел-Ани-оф. cpp**

## <a name="see-also"></a>См. также раздел

[Переход от OpenMP к среде выполнения с параллелизмом](../../parallel/concrt/migrating-from-openmp-to-the-concurrency-runtime.md)<br/>
[Отмена в библиотеке параллельных шаблонов](cancellation-in-the-ppl.md)<br/>
[Параллельные алгоритмы](../../parallel/concrt/parallel-algorithms.md)
