---
title: Пошаговое руководство. Обновление приложения MFC Scribble (часть 1)
ms.date: 09/09/2019
helpviewer_keywords:
- examples [MFC], update existing application
- ribbon UI, porting to
- Office Fluent UI, porting to
- samples [MFC], update existing application
- MFC Feature Pack, update existing application
- walkthroughs [MFC], update existing application
ms.assetid: aa6330d3-6cfc-4c79-8fcb-0282263025f7
ms.openlocfilehash: a9eda80fbabf939b9e3a5f8a0ef5b76e46656740
ms.sourcegitcommit: ec6dd97ef3d10b44e0fedaa8e53f41696f49ac7b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/25/2020
ms.locfileid: "88840262"
---
# <a name="walkthrough-updating-the-mfc-scribble-application-part-1"></a>Пошаговое руководство. Обновление приложения MFC Scribble (часть 1)

В этом пошаговом руководстве показано, как изменить существующее приложение MFC для использования пользовательского интерфейса Ribbon. Visual Studio поддерживает как ленту Office 2007, так и ленту Сценик Windows 7. Дополнительные сведения о пользовательском интерфейсе Ribbon см. в разделе [ленты](/windows/win32/uxguide/cmd-ribbons).

В этом пошаговом руководстве изменяется классический пример MFC Scribble 1,0, позволяющий использовать мышь для создания чертежей линий. В этой части пошагового руководства показано, как изменить образец Scribble таким образом, чтобы он отображал панель ленты. [Часть 2](../mfc/walkthrough-updating-the-mfc-scribble-application-part-2.md) добавляет дополнительные кнопки на панель ленты.

## <a name="prerequisites"></a>Обязательные условия

[Пример MFC scribble 1,0](https://download.microsoft.com/download/4/0/9/40946FEC-EE5C-48C2-8750-B0F8DA1C99A8/MFC/general/Scribble.zip.exe). Справку по преобразованию в Visual Studio 2017 или более поздней версии см. в разделе [руководство по переносу: MFC Scribble](../porting/porting-guide-mfc-scribble.md).

## <a name="sections"></a><a name="top"></a> Священ

Эта часть пошагового руководства содержит следующие разделы.

- [Замена базовых классов](#replaceclass)

- [Добавление точечных рисунков в проект](#addbitmap)

- [Добавление в проект ресурса ленты](#addribbon)

- [Создание экземпляра панели ленты](#createinstance)

- [Добавление категории ленты](#addcategory)

- [Настройка вида приложения](#setlook)

## <a name="replacing-the-base-classes"></a><a name="replaceclass"></a> Замена базовых классов

Чтобы преобразовать приложение, которое поддерживает меню, в приложение, которое поддерживает ленту, необходимо создать классы приложения, окна фрейма и панели инструментов из обновленных базовых классов. (Мы рекомендуем не изменять исходный образец Scribble. Вместо этого очистите проект Scribble, скопируйте его в другой каталог, а затем измените копию.)

### <a name="to-replace-the-base-classes-in-the-scribble-application"></a>Замена базовых классов в приложении Scribble

1. В Scribble. cpp убедитесь, что `CScribbleApp::InitInstance` включает вызов [афксолеинит](../mfc/reference/ole-initialization.md#afxoleinit).

1. Добавьте следующий код в файл *PCH.h* (*stdafx.h* в Visual Studio 2017 и более ранних версиях):

    ```cpp
    #include <afxcontrolbars.h>
    ```

1. В Scribble.h измените определение `CScribbleApp` класса таким образом, чтобы оно было производным от [класса CWinAppEx](../mfc/reference/cwinappex-class.md).

    ```cpp
    class CScribbleApp: public CWinAppEx
    ```

1. Scribble 1,0 был написан, когда приложения Windows использовали файл инициализации (. ini) для сохранения данных предпочтений пользователя. Вместо файла инициализации измените Scribble, чтобы сохранить настройки пользователя в реестре. Чтобы задать раздел реестра и базу данных, введите следующий код в `CScribbleApp::InitInstance` после `LoadStdProfileSettings()` инструкции.

    ```cpp
    SetRegistryKey(_T("MFCNext\\Samples\\Scribble2"));
    SetRegistryBase(_T("Settings"));
    ```

1. Основной фрейм для приложения с многодокументным интерфейсом (MDI) больше не является производным от `CMDIFrameWnd` класса. Вместо этого он является производным от класса [CMDIFrameWndEx](../mfc/reference/cmdiframewndex-class.md) .

    В файлах маинфрм.h и маинфрм. cpp замените все ссылки на `CMDIFrameWnd` `CMDIFrameWndEx` .

1. В файлах чилдфрм.h и чилдфрм. cpp замените `CMDIChildWnd` на `CMDIChildWndEx` .

    В чилдфрм.h файл, замените `CSplitterWnd` на `CSplitterWndEx` .

1. Измените панели инструментов и строки состояния, чтобы они использовали новые классы MFC.

    В файле маинфрм.h:

    1. Замените `CToolBar` на `CMFCToolBar`.

    1. Замените `CStatusBar` на `CMFCStatusBar`.

1. В файле маинфрм. cpp:

    1. Замените `m_wndToolBar.SetBarStyle` на `m_wndToolBar.SetPaneStyle`:

    1. Замените `m_wndToolBar.GetBarStyle` на `m_wndToolBar.GetPaneStyle`:

    1. Замените `DockControlBar(&m_wndToolBar)` на `DockPane(&m_wndToolBar)`:

1. В файле ипфраме. cpp закомментируйте следующие три строки кода.

    ```cpp
    m_wndToolBar.EnableDocking(CBRS_ALIGN_ANY);
    pWndFrame->EnableDocking(CBRS_ALIGN_ANY);
    pWndFrame->DockPane(&m_wndToolBar);
    ```

1. Сохраните изменения, а затем выполните сборку и запуск приложения.

## <a name="adding-bitmaps-to-the-project"></a><a name="addbitmap"></a> Добавление точечных рисунков в проект

В следующих четырех шагах этого пошагового руководства требуются ресурсы точечного рисунка. Получить соответствующие точечные рисунки можно различными способами.

- Используйте [редакторы ресурсов](../windows/resource-editors.md) для инвентаризации собственных растровых изображений. Или используйте редакторы ресурсов для сборки точечных рисунков из изображений PNG, которые входят в состав Visual Studio и могут быть скачаны из [библиотеки изображений Visual Studio](/visualstudio/designers/the-visual-studio-image-library).

    Однако пользовательский интерфейс **ленты** требует, чтобы определенные точечные рисунки поддерживали прозрачные изображения. Прозрачные точечные рисунки используют 32 бит, где 24 бита задают красный, зеленый и синий компоненты цвета, а 8 бит определяют *альфа-канал* , указывающий прозрачность цвета. Текущие редакторы ресурсов могут просматривать, но не изменять точечные рисунки с 32-разрядными пикселами. Следовательно, для работы с прозрачными точечными рисунками вместо редакторов ресурсов используйте внешний редактор изображений.

- Скопируйте соответствующий файл ресурсов из другого приложения в проект, а затем импортируйте точечные рисунки из этого файла.

В этом пошаговом руководстве копируются файлы ресурсов из примера, созданного в [разделе Пошаговое руководство. Создание ленточного приложения с помощью MFC](../mfc/walkthrough-creating-a-ribbon-application-by-using-mfc.md).

### <a name="to-add-bitmaps-to-the-project"></a>Добавление точечных рисунков в проект

1. С помощью проводника скопируйте следующие BMP-файлы из каталога ресурсов ( `res` ) примера ленты в каталог ресурсов ( `res` ) проекта Scribble.

   1. Скопируйте main.bmp в проект Scribble.

   1. Скопируйте filesmall.bmp и filelarge.bmp в проект Scribble.

   1. Создайте новые копии filelarge.bmp и filesmall.bmp файлов, но сохраните копии на ленте. Переименуйте копии homesmall.bmp и homelarge.bmp а затем переместите копии в проект Scribble.

   1. Создайте копию файла toolbar.bmp, но сохраните копию в примере ленты. Переименуйте panelicons.bmp копирования, а затем переместите копию в проект Scribble.

1. Импортируйте точечный рисунок для приложения MFC. В **представление ресурсов**дважды щелкните узел **Scribble. RC** , дважды щелкните узел **Bitmap** , а затем щелкните **Добавить ресурс**. В открывшемся диалоговом окне нажмите кнопку **Импорт**. Перейдите в `res` каталог, выберите файл main.bmp и нажмите кнопку **Открыть**.

   Точечный рисунок main.bmp содержит изображение 26x26. Измените идентификатор точечного рисунка на `IDB_RIBBON_MAIN` .

1. Импортируйте точечные рисунки для меню "файл", присоединенного к кнопке **приложения** .

   1. Импортируйте файл filesmall.bmp, содержащий одиннадцать изображений размером 16x16 (16x176). Измените идентификатор точечного рисунка на `IDB_RIBBON_FILESMALL` .

   > [!NOTE]
   > Так как нам нужны только первые восемь изображений размером 16x16 (16x128), вы можете при необходимости обрезать ширину правой стороны этого точечного рисунка с 176 до 128.

   1. Импортируйте filelarge.bmp, содержащий девять изображений размером 32x32 (32x288). Измените идентификатор точечного рисунка на `IDB_RIBBON_FILELARGE` .

1. Импортируйте растровые изображения для категорий и панелей ленты. Каждая вкладка на панели ленты является категорией и состоит из текстовой метки и дополнительного изображения.

   1. Импортируйте homesmall.bmp точечный рисунок, содержащий одиннадцать изображений размером 16x16 значков для мелких растровых кнопок. Измените идентификатор точечного рисунка на `IDB_RIBBON_HOMESMALL` .

   1. Импортируйте homelarge.bmp точечный рисунок, который содержит девять изображений размером 32x32 изображения для крупных растровых кнопок. Измените идентификатор точечного рисунка на `IDB_RIBBON_HOMELARGE` .

1. Импорт растровых изображений для панелей ленты с измененным размером. Эти растровые изображения или значки панели используются после операции изменения размера, если лента слишком мала для показа всей панели.

   1. Импортируйте panelicons.bmp точечный рисунок, содержащий восемь изображений размером 16x16. В окне **Свойства** **редактора растрового изображения**измените ширину точечного рисунка на 64 (16x64). Измените идентификатор точечного рисунка на `IDB_PANEL_ICONS` .

   > [!NOTE]
   > Поскольку нам нужны только первые четыре изображения размером 16x16 изображений (16x64), вы можете при необходимости обрезать ширину правой стороны этого точечного рисунка с 128 до 64.

## <a name="adding-a-ribbon-resource-to-the-project"></a><a name="addribbon"></a> Добавление в проект ресурса ленты

При преобразовании приложения, использующего меню, в приложение, использующее ленту, удалять или отключать существующие меню не требуется. Просто создайте ресурс ленты, добавьте кнопки ленты, а затем свяжите новые кнопки с существующими элементами меню. Несмотря на то, что меню больше не видны, сообщения из панели ленты направляются через меню и ярлыки меню продолжают работать.

Лента состоит из кнопки **приложение** , которая является большой кнопкой в верхней левой части ленты, и одной или нескольких вкладок категорий. Каждая вкладка Категория содержит одну или несколько панелей, которые служат контейнерами для кнопок и элементов управления на ленте. В следующей процедуре показано, как создать ресурс ленты, а затем настроить кнопку **приложения** .

### <a name="to-add-a-ribbon-resource-to-the-project"></a>Добавление в проект ресурса ленты

1. Выбрав проект Scribble в **Обозреватель решений**, в меню **проект** выберите команду **Добавить ресурс**.

1. В диалоговом окне **Добавление ресурса** выберите **Лента** и нажмите кнопку **создать**.

   Visual Studio создает ресурс ленты и открывает его в режиме конструктора. Идентификатор ресурса ленты — `IDR_RIBBON1` , который отображается в **представление ресурсов**. Лента содержит одну категорию и одну панель.

1. Можно настроить кнопку **приложения** , изменив ее свойства. Идентификаторы сообщений, используемые в этом коде, уже определены в меню для Scribble 1,0.

1. В режиме конструктора нажмите кнопку **приложение** , чтобы отобразить его свойства. Измените значения свойств следующим образом: **Image** to `IDB_RIBBON_MAIN` , **Prompt** to, a, `File` **Keys** `f` **Large Images** to `IDB_RIBBON_FILELARGE` и **Small** Images to `IDB_RIBBON_FILESMALL` .

1. Следующие изменения создают меню, которое появляется при нажатии пользователем кнопки **приложения** . Нажмите кнопку с многоточием (**...**) рядом с пунктом **основные элементы** , чтобы открыть **Редактор элементов**.

   1. Выбрав **кнопку** тип **элемента** , нажмите кнопку **добавить** , чтобы добавить кнопку. Измените **заголовок** на, с `&New` **ID** на `ID_FILE_NEW` , **изображение** на `0` , **изображение размером** в `0` .

   1. Нажмите кнопку **Добавить** , чтобы добавить кнопку. Измените **заголовок** на `&Save` , **ID** на `ID_FILE_SAVE` , **Image** to `2` , **Image Large** to `2` .

   1. Нажмите кнопку **Добавить** , чтобы добавить кнопку. Измените **заголовок** на `Save &As` , **ID** на `ID_FILE_SAVE_AS` , **Image** to `3` , **Image Large** to `3` .

   1. Нажмите кнопку **Добавить** , чтобы добавить кнопку. Измените **заголовок** на `&Print` , **ID** на `ID_FILE_PRINT` , **Image** to `4` , **Image Large** to `4` .

   1. Измените тип **элемента** на **Разделитель** и нажмите кнопку **добавить**.

   1. Измените тип **элемента** на **кнопка**. Нажмите кнопку **Добавить** , чтобы добавить пятую кнопку. Измените **заголовок** на `&Close` , **ID** на `ID_FILE_CLOSE` , **Image** to `5` , **Image Large** to `5` .

1. Следующие изменения создают подменю под кнопкой **Печать** , созданной на предыдущем шаге.

   1. Нажмите кнопку **Печать** , измените тип **элемента** на **Метка**, а затем нажмите кнопку **Вставить**. Измените **заголовок** на `Preview and print the document` .

   1. Нажмите кнопку **Печать** , измените тип **элемента** на **кнопка**и нажмите кнопку **Вставить**. Измените **заголовок** на `&Print` , **ID** на `ID_FILE_PRINT` , **Image** to `4` , **Image Large** to `4` .

   1. Нажмите кнопку **Печать** , а затем нажмите кнопку **Вставить** , чтобы добавить кнопку. Измените **заголовок** на `&Quick Print` , **ID** на `ID_FILE_PRINT_DIRECT` , **Image** to `7` , **Image Large** to `7` .

   1. Нажмите кнопку **Печать** , а затем нажмите кнопку **Вставить** , чтобы добавить еще одну кнопку. Измените **заголовок** на `Print Pre&view` , **ID** на `ID_FILE_PRINT_PREVIEW` , **Image** to `6` , **Image Large** to `6` .

   1. Теперь вы изменили **основные элементы**. Нажмите кнопку **Закрыть** , чтобы выйти из **редактора элементов**.

1. При следующем изменении создается кнопка выйти, которая появляется в нижней части меню кнопки **приложения** .

   1. Выберите вкладку **представление ресурсов** в **Обозреватель решений**.
   1. В окне **Свойства** нажмите кнопку с многоточием (**...**) рядом с **кнопкой** , чтобы открыть **Редактор элементов**.

   1. Выбрав **кнопку** тип **элемента** , нажмите кнопку **добавить** , чтобы добавить кнопку. Измените **заголовок** на `E&xit` , **ID** на `ID_APP_EXIT` , **Image** to `8` .

   1. Вы изменили **кнопки**. Нажмите кнопку **Закрыть** , чтобы выйти из **редактора элементов**.

## <a name="creating-an-instance-of-the-ribbon-bar"></a><a name="createinstance"></a> Создание экземпляра панели ленты

В следующих шагах показано, как создать экземпляр панели ленты при запуске приложения. Чтобы добавить в приложение ленту, объявите панель ленты в файле маинфрм.h. Затем в файле маинфрм. cpp напишите код для загрузки ресурса ленты.

### <a name="to-create-an-instance-of-the-ribbon-bar"></a>Создание экземпляра панели ленты

1. В файле маинфрм.h добавьте член данных в защищенный раздел `CMainFrame` определения класса для основного фрейма. Этот элемент относится к панели ленты.

    ```cpp
    // Ribbon bar for the application
    CMFCRibbonBar m_wndRibbonBar;
    ```

2. В файле маинфрм. cpp добавьте следующий код перед завершающей **`return`** инструкцией в конце `CMainFrame::OnCreate` функции. Он создает экземпляр панели ленты.

    ```cpp
    // Create the ribbon bar
    if (!m_wndRibbonBar.Create(this))
    {
        return -1;   //Failed to create ribbon bar
    }
    m_wndRibbonBar.LoadFromResource(IDR_RIBBON1);
    ```

## <a name="customizing-the-ribbon-resource"></a><a name="addcategory"></a> Настройка ресурса ленты

Теперь, когда вы создали кнопку **приложения** , можно добавить элементы на ленту.

> [!NOTE]
> В этом пошаговом руководстве используется один и тот же значок панели для всех панелей. Однако можно использовать другие индексы списка изображений для вывода других значков.

### <a name="to-add-a-home-category-and-edit-panel"></a>Добавление домашней категории и панели редактирования

1. Программе Scribble требуется только одна категория. В представлении конструктора в **области элементов**дважды щелкните **Категория** , чтобы добавить ее и отобразить ее свойства. Измените значения свойств следующим образом: **заголовок** `&Home` , **крупные изображения** — для `IDB_RIBBON_HOMELARGE` **небольших изображений** `IDB_RIBBON_HOMESMALL` .

1. Каждая категория ленты организована в именованные панели. Каждая панель содержит набор элементов управления, которые завершают связанные операции. Эта категория содержит одну панель. Щелкните **панель**, а затем измените **заголовок** на `Edit` .

1. На панель **редактирования** добавьте кнопку, ответственную за очистку содержимого документа. Идентификатор сообщения для этой кнопки уже определен в `IDR_SCRIBBTYPE` ресурсе меню. Укажите в `Clear All` качестве текста кнопки и индекс растрового изображения, определяющего кнопку. Откройте **панель элементов**и перетащите **кнопку** на панель **изменить** . Нажмите кнопку, а затем измените **заголовок** на, с `Clear All` **ID** на `ID_EDIT_CLEAR_ALL` , **индекс изображения** на `0` , **крупный индекс изображения** на `0` .

1. Сохраните изменения, а затем выполните сборку и запуск приложения. Приложение Scribble должно отображаться, а в верхней части окна должна быть панель ленты, а не строка меню. На панели ленты должна быть одна категория, **Главная**и **Домашняя страница** , которая должна иметь одну панель, **изменить**. Добавленные кнопки ленты должны быть связаны с существующими обработчиками событий, а кнопки " **Открыть**", " **Закрыть**", " **сохранить**", " **Печать**" и " **Очистить все** " должны работать правильно.

## <a name="setting-the-look-of-the-application"></a><a name="setlook"></a> Настройка вида приложения

*Визуальный диспетчер* — это глобальный объект, который управляет всем рисованием приложения. Поскольку исходное приложение Scribble использует стиль пользовательского интерфейса Office 2000, приложение может выглядеть старым. Можно сбросить приложение для использования визуального диспетчера Office 2007, чтобы оно было похоже на приложение Office 2007.

### <a name="to-set-the-look-of-the-application"></a>Задание вида приложения

1. В `CMainFrame::OnCreate` функции введите следующий код перед `return 0;` оператором, чтобы изменить визуальный диспетчер и стиль по умолчанию.

    ```cpp
    // Set the default manager to Office 2007
    CMFCVisualManager::SetDefaultManager(RUNTIME_CLASS(CMFCVisualManagerOffice2007));
    CMFCVisualManagerOffice2007::SetStyle(CMFCVisualManagerOffice2007::Office2007_LunaBlue);
    ```

1. Сохраните изменения, а затем выполните сборку и запуск приложения. Пользовательский интерфейс приложения должен быть похож на пользовательский интерфейс Office 2007.

## <a name="next-steps"></a>Следующие шаги

Вы изменили классический пример MFC Scribble 1,0 для использования **конструктора лент**. Теперь перейдите к [части 2](../mfc/walkthrough-updating-the-mfc-scribble-application-part-2.md).

## <a name="see-also"></a>См. также раздел

[Пошаговые руководства](../mfc/walkthroughs-mfc.md)<br/>
[Пошаговое руководство. Обновление приложения MFC Scribble (часть 2)](../mfc/walkthrough-updating-the-mfc-scribble-application-part-2.md)
